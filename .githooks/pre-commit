#!/bin/bash
set -e

echo "🔍 Tìm các file schema Zod thay đổi trong thư mục /zod..."

# Lấy danh sách các file JS staged nằm trong thư mục /zod/
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^zod/.*\.js$' || true)

for FILE in $FILES; do
  echo "🛠 Generating JSON Schema từ: $FILE"
  
  OUT_FILE="json-schema/${FILE%.js}.json"

  # Tạo thư mục nếu chưa có
  mkdir -p "$(dirname "$OUT_FILE")"

  # Generate JSON Schema và ghi ra file
  ./libs/bun ./generate.sh "$FILE" > "$OUT_FILE"

  # Add file đã generate vào commit
  git add "$OUT_FILE"
done

echo "✅ Xong. Đã generate + add lại các schema thay đổi."
